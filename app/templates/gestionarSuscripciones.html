{% extends "layout.html" %}
{% block title %}Gestionar Suscripciones{% endblock %}

{% block content %}
<div class="container py-4">
  <div class="d-flex align-items-center justify-content-between mb-3">
    <h2 class="mb-0">Gestionar Suscripciones</h2>
    <a href="{{ url_for('suscripcion.crear') }}" class="btn btn-primary">
      <i class="bi bi-plus-circle me-1"></i> Nueva suscripción
    </a>
  </div>

  <!-- Filtros -->
  <form method="GET" class="row g-2 align-items-end mb-3">
    <div class="col-md-3">
      <label class="form-label">Proveedor</label>
      <select class="form-select" name="proveedor_id">
        <option value="">— Todos —</option>
        {% for pid, pnombre in prov_choices %}
          <option value="{{ pid }}" {{ 'selected' if filtro_proveedor == pid else '' }}>
            {{ pnombre }}
          </option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-3">
      <label class="form-label">Categoría</label>
      <select class="form-select" name="categoria_id">
        <option value="">— Todas —</option>
        {% for cid, cnombre in cat_choices %}
          <option value="{{ cid }}" {{ 'selected' if filtro_categoria == cid else '' }}>
            {{ cnombre }}
          </option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-3">
      <label class="form-label">Estado</label>
      <select class="form-select" name="estado">
        <option value="">— Todos —</option>
        <option value="ACTIVA"   {{ 'selected' if filtro_estado == 'ACTIVA' else '' }}>Activa</option>
        <option value="PAUSADA"  {{ 'selected' if filtro_estado == 'PAUSADA' else '' }}>Pausada</option>
        <option value="CANCELADA"{{ 'selected' if filtro_estado == 'CANCELADA' else '' }}>Cancelada</option>
      </select>
    </div>
    <div class="col-md-3">
      <button class="btn btn-outline-primary w-100">
        <i class="bi bi-funnel me-1"></i> Filtrar
      </button>
    </div>
  </form>

  <!-- Tabla -->
  <div class="table-responsive">
    <table class="table table-hover align-middle">
      <thead class="table-light">
        <tr>
          <th>Nombre</th>
          <th>Proveedor</th>
          <th>Categoría</th>
          <th class="text-end">Precio</th>
          <th>Frecuencia</th>
          <th>Próximo cobro</th>
          <th>Estado</th>
          <th style="width: 220px;">Acciones</th>
        </tr>
      </thead>
      <tbody>
        {% if suscripciones %}
          {% for s in suscripciones %}
            <tr>
              <td>{{ s.nombre }}</td>
              <td>{{ prov_map.get(s.proveedorId, '-') }}</td>
              <td>{{ cat_map.get(s.categoriaId, '-') }}</td>
              <td class="text-end">₡ {{ '%.2f'|format(s.precio or 0) }}</td>
              <td>{{ s.frecuencia }}</td>
              <td>{% if s.proximoCobro %}{{ s.proximoCobro.strftime('%Y-%m-%d') }}{% else %}-{% endif %}</td>
              <td>
                <span class="badge
                  {% if s.estado=='ACTIVA' %} bg-success
                  {% elif s.estado=='PAUSADA' %} bg-warning text-dark
                  {% else %} bg-secondary {% endif %}">
                  {{ s.estado }}
                </span>
              </td>
              <td class="d-flex gap-1">
                <!-- Editar -->
                <a href="{{ url_for('suscripcion.editar', sid=s.sid) }}"
                   class="btn btn-sm btn-outline-secondary" title="Editar">
                  <i class="bi bi-pencil"></i>
                </a>

                <!-- Registrar pago-->
                <form action="{{ url_for('suscripcion.registrar_pago', sid=s.sid) }}"
                      method="POST" class="d-inline"
                      onsubmit="return confirm('¿Registrar pago con el precio actual?');">
                  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                  <button class="btn btn-sm btn-outline-success" title="Registrar pago">
                    <i class="bi bi-cash-coin"></i>
                  </button>
                </form>

                <!-- Simular aumento-->
                <a href="{{ url_for('suscripcion.aumento_form', sid=s.sid) }}"
                   class="btn btn-sm btn-outline-primary" title="Simular aumento de precio">
                  <i class="bi bi-graph-up-arrow"></i>
                </a>

                <!-- Eliminar-->
                <form action="{{ url_for('suscripcion.eliminar', sid=s.sid) }}"
                      method="POST" class="d-inline"
                      onsubmit="return confirm('¿Eliminar esta suscripción?');">
                  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                  <button class="btn btn-sm btn-outline-danger" title="Eliminar">
                    <i class="bi bi-trash"></i>
                  </button>
                </form>
              </td>
            </tr>
          {% endfor %}
        {% else %}
          <tr>
            <td colspan="8" class="text-center text-muted py-4">
              No hay suscripciones.
            </td>
          </tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}
