{% extends "layout.html" %}
{% block title %}Pagos{% endblock %}

{% block content %}
<div class="container py-4">
  <div class="d-flex align-items-center justify-content-between mb-3">
    <h2 class="mb-0">Pagos</h2>
    <div>
      <a class="btn btn-outline-secondary"
         href="{{ url_for('pago.listar', desde=f_desde, hasta=f_hasta, categoria_id=f_cat, proveedor_id=f_prov, export='csv') }}">
        <i class="bi bi-download"></i> Exportar CSV
      </a>
    </div>
  </div>

  <!-- Filtros -->
  <form class="row g-2 mb-3" method="GET" action="{{ url_for('pago.listar') }}">
    <div class="col-md-2">
      <label class="form-label">Desde</label>
      <input type="date" class="form-control" name="desde" value="{{ f_desde }}">
    </div>
    <div class="col-md-2">
      <label class="form-label">Hasta</label>
      <input type="date" class="form-control" name="hasta" value="{{ f_hasta }}">
    </div>
    <div class="col-md-3">
      <label class="form-label">Categoría</label>
      <select name="categoria_id" class="form-select">
        <option value="">— Todas —</option>
        {% for cid, cname in cat_choices %}
          <option value="{{ cid }}" {{ 'selected' if cid==f_cat else '' }}>{{ cname }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-3">
      <label class="form-label">Proveedor</label>
      <select name="proveedor_id" class="form-select">
        <option value="">— Todos —</option>
        {% for pid, pname in prov_choices %}
          <option value="{{ pid }}" {{ 'selected' if pid==f_prov else '' }}>{{ pname }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-2 d-flex align-items-end">
      <button class="btn btn-primary w-100" type="submit">Filtrar</button>
    </div>
  </form>

  <div class="mb-3">
    <span class="text-muted">Total en lista:</span>
    <strong>CRC {{ '%.0f'|format(total|default(0)) }}</strong>
  </div>

  <div class="table-responsive bg-white rounded shadow-sm">
    <table class="table table-hover align-middle mb-0">
      <thead class="table-light">
        <tr>
          <th>Proveedor</th>
          <th>Categoría</th>
          <th class="text-end">Monto (CRC)</th>
          <th>Método de pago</th>
          <th>Notas</th>
          <th class="text-end">Acciones</th>
        </tr>
      </thead>
      <tbody>
        {% if pagos %}
          {% for p in pagos %}
          <tr>
            <td>{{ p.proveedorNombre or '-' }}</td>
            <td>{{ p.categoriaNombre or '-' }}</td>
            <td class="text-end">{{ '%.0f'|format(p.monto|default(0)) }}</td>
            <td>{{ p.metodoPagoAlias or '-' }}</td>
            <td class="text-truncate" style="max-width: 240px;">{{ p.notas or '' }}</td>
            <td class="text-end">
            <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('pago.editar', pid=p.pid) }}">Editar</a>

              <form class="d-inline" method="POST" action="{{ url_for('pago.eliminar', pid=p.pid) }}"
                    onsubmit="return confirm('¿Eliminar pago?');">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button class="btn btn-sm btn-outline-danger" type="submit">Eliminar</button>
              </form>
            </td>
          </tr>
          {% endfor %}
        {% else %}
          <tr><td colspan="6" class="text-center text-muted py-4">No hay pagos con los filtros actuales.</td></tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}
